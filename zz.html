<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ArUco ID Detector</title>
  <style>
    video, canvas {
      width: 100%;
      max-width: 500px;
      margin-top: 10px;
    }
    #idOutput {
      font-size: 24px;
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>
  <h2>ðŸ“· ArUco ID Detector</h2>
  <button onclick="startCamera()">Start Camera</button>
  <br>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="idOutput">ID: --</div>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let streaming = false;
    let dictionary;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" } // back camera
        }
      }).then(function(stream) {
        video.srcObject = stream;
        video.play();
      });
    }

    function onOpenCvReady() {
      console.log('OpenCV.js Loaded âœ…');
      dictionary = new cv.aruco_Dictionary(cv.DICT_4X4_50);
      streaming = true;
      detectMarkers();
    }

    function detectMarkers() {
      if (!streaming) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      let src = cv.imread(canvas);
      let markerCorners = new cv.MatVector();
      let markerIds = new cv.Mat();
      let parameters = new cv.aruco_DetectorParameters();
      let detector = new cv.aruco_Detector(dictionary, parameters);
      detector.detectMarkers(src, markerCorners, markerIds);

      if (markerIds.rows > 0) {
        let idText = Array.from(markerIds.data32S).join(', ');
        document.getElementById('idOutput').innerText = `ID: ${idText}`;
        console.log("Detected ID:", idText);
      }

      src.delete(); markerCorners.delete(); markerIds.delete(); parameters.delete(); detector.delete();
      requestAnimationFrame(detectMarkers);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>🎯 ArUco ID Detection</title>
  <style>
    video, canvas { max-width: 100%; margin-top: 10px; }
    #output { font-size: 20px; color: green; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>📷 ArUco Marker Detector (Back Camera)</h2>
  <video id="video" autoplay playsinline></video>
  <br>
  <button onclick="captureAndDetect()">📸 Capture & Detect</button>
  <br>
  <canvas id="canvas"></canvas>
  <div id="output">Detected ID: None</div>

  <!-- Load OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let output = document.getElementById("output");

    // ✅ Step 1: Access Back Camera
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    }).then(stream => {
      video.srcObject = stream;
    }).catch(err => {
      output.innerText = "❌ Camera not found: " + err.message;
    });

    let cvReady = false;

    function onOpenCvReady() {
      cvReady = true;
      output.innerText = "✅ OpenCV.js loaded!";
    }

    // ✅ Step 2: Capture frame and detect
    function captureAndDetect() {
      if (!cvReady) {
        output.innerText = "⏳ OpenCV.js not yet loaded";
        return;
      }

      // Draw video frame to canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      let ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // OpenCV image processing
      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

      let dictionary = new cv.aruco.getPredefinedDictionary(cv.aruco.DICT_4X4_50);
      let corners = new cv.MatVector();
      let ids = new cv.Mat();
      let rejected = new cv.MatVector();

      cv.aruco.detectMarkers(gray, dictionary, corners, ids, undefined, rejected);

      if (ids.rows > 0) {
        output.innerText = "🎯 Detected ID(s): " + ids.data32S.join(", ");
        cv.aruco.drawDetectedMarkers(src, corners, ids);
      } else {
        output.innerText = "😕 No marker detected";
      }

      cv.imshow(canvas, src);

      // Cleanup
      src.delete(); gray.delete(); corners.delete(); ids.delete(); rejected.delete();
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="icon" href="image/favicon.ico" type="image/x-icon">
    <title>KhataBook - Customer</title>
    <link rel="stylesheet" href="stylesKhata.css">
</head>

<body>
    <div class="topHeader">
        <a href="indexKhata.html">
            <img class="logo" src="image/logo.png" alt="loading">
        </a>
        <p class="bold">My Card: <span id="total-card-amount">0</span> â‚¹ ğŸ’³</p>
        <p class="bold">Earning: <span id="total-income">0</span> â‚¹ ğŸ’µ</p>

    </div>
    <div class="header">
        <h2 id="headerName">SalikRam Panipudi Wale </h2>
        <p style="font-size: small;">ğŸ¡<span id="headerAddress">Utarthiya sadarganj By paas road near KD Hospital</span>
        </p>

    </div>
    <div id="internet-status"
        style="display: none; color: red; text-align: center; font-weight: bold; background-color: yellow; padding: 10px;">
        âš ï¸ You're offline or internet is slow.
    </div>
    <div class="mainDiv">
        <div class="leftDiv"> <button onclick="window.location.href='indexKhata.html';"> Back
            </button></div>
        <div class="rightDiv">
            <button
                onclick="window.location.href='tel:1234567890'; speakMessage('à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤¤à¤°à¤¹ à¤•à¤¾ à¤¹à¥‡à¤²à¥à¤ª à¤•à¥‡ à¤²à¤¿à¤, à¤•à¥‰à¤² à¤•à¤°à¥‡à¤‚, à¤¯à¤¾ à¤µà¥à¤¹à¤¾à¤Ÿà¥à¤¸à¤ªà¥à¤ª à¤šà¥ˆà¤Ÿ à¤•à¤°à¥‡à¤‚ ');">
                ğŸ“ Help
            </button>
        </div>
    </div>
    <div class="transactionsInput">
        <h1>Transactions</h1>
        <div class="name-input-container">
            <input type="text" id="customer-name" placeholder="Enter Your name Number" required list="name-list">
            <datalist id="name-list"></datalist>
        </div>

        <div class="phone-input-container">
            <input type="text" id="customer-phone" placeholder="Enter Your Phone Number" required list="phone-list">
            <datalist id="phone-list"></datalist>
        </div></br>

        <button onclick="loadCustomerTransactions()">View Transactions</button>
    </div>
    <div id="transactions" class="transactions">
        <div id="salerName" style="display: none;">
            <img class="logo" src="image/logo.png" alt="loading">
            <h2> SalikRam Panipudi Wale </h2>
        </div>
        <div class="mainDiv" id="printBtn">
            <div class="leftDiv">
                <button onclick="takeImage()"> Print ğŸ–¨ï¸ </button>
                <button onclick="shareImage()"> Share â¤ </button>
            </div>
            <div class="rightDiv">
                <select id="transaction-filter" onchange="loadCustomerTransactions()">
                    <option value="" disabled>Arrange Customer</option>
                    <option value="week">Last Week</option>
                    <option value="ten">10 Days</option>
                    <option value="month" selected>Last 1 Month</option>
                    <option value="six-months">Last 6 Months</option>
                    <option value="year">Last Year</option>
                    <option value="twoyear">Last 2 Year</option>
                    <option value="fiveyear">Last 5 Year</option>
                </select>
            </div>
        </div>

        <div class="space"></div>
        <div class="line"></div>
        <div class="space"></div>

        <ul id="transaction-list"></ul>
        <p id="transaction-datetime"></p><!--Temp -->
    </div>


    <script src="functionKhata.js"></script>
    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, doc, getDocs, query, collection } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCV1ShZVpRQFIpckrwRzTBLokZH10LgH8w",
            authDomain: "business-khata-360.firebaseapp.com",
            projectId: "business-khata-360",
            storageBucket: "business-khata-360.firebasestorage.app",
            messagingSenderId: "904600080282",
            appId: "1:904600080282:web:182fde2c1ffacd0f4db423",
            measurementId: "G-X9NRDYZY1C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function loadPhoneNumber() {
            const phoneList = document.getElementById('phone-list');
            phoneList.innerHTML = "";  // Clear existing options
            const querySnapshot = await getDocs(collection(db, "customers1"));
            querySnapshot.forEach((doc) => {
                const customer = doc.data();
                const option = document.createElement('option');
                option.value = customer.phone;
                phoneList.appendChild(option);
            });
        }
        async function loadName() {
            const nameList = document.getElementById('name-list');
            nameList.innerHTML = "";  // Clear existing options
            const querySnapshot = await getDocs(collection(db, "customers1"));
            const customers = [];
            querySnapshot.forEach((doc) => {
                const customer = doc.data();
                customers.push(customer); // âœ… à¤¸à¤­à¥€ à¤—à¥à¤°à¤¾à¤¹à¤•à¥‹à¤‚ à¤•à¥‹ à¤à¤°à¥‡ à¤®à¥‡à¤‚ à¤¸à¥‡à¤µ à¤•à¤°à¥‹
                const option = document.createElement('option');
                option.value = customer.name;
                nameList.appendChild(option);
            });
            // âœ… à¤œà¤¬ à¤¨à¤¾à¤® à¤¸à¥‡à¤²à¥‡à¤•à¥à¤Ÿ à¤¹à¥‹, à¤¤à¥‹ à¤«à¥‹à¤¨ à¤¨à¤‚à¤¬à¤° à¤‡à¤¨à¤ªà¥à¤Ÿ à¤®à¥‡à¤‚ à¤† à¤œà¤¾à¤
            document.getElementById('customer-name').addEventListener('input', function () {
                const selectedName = this.value;
                const matchedCustomer = customers.find(c => c.name === selectedName);
                if (matchedCustomer) {
                    document.getElementById('customer-phone').value = matchedCustomer.phone; // âœ… à¤¸à¤¹à¥€ à¤«à¥‹à¤¨ à¤¨à¤‚à¤¬à¤° à¤¸à¥‡à¤Ÿ à¤•à¤° à¤¦à¥‹
                }
            });
        }

        window.loadCustomerTransactions = async function () {
            document.querySelector('.transactions').style.display = "block";
            const phone = document.getElementById('customer-phone').value;
            const filter = document.getElementById('transaction-filter').value; // Get selected filter
            if (phone) {
                const q = query(collection(db, "customers1"));
                const querySnapshot = await getDocs(q);
                const transactionList = document.getElementById('transaction-list');
                transactionList.innerHTML = "";

                querySnapshot.forEach((doc) => {
                    const customer = doc.data();
                    if (customer.phone === phone) {
                        document.getElementById('total-card-amount').textContent = customer.totalCardAmount;
                        document.getElementById('total-income').textContent = customer.totalIncome;

                        const name = document.createElement('h3');
                        const li = document.createElement('h5');
                        name.textContent = `Name : ${customer.name}-  My Phone No: ${customer.phone}ğŸ“`;


                        document.getElementById('headerName').textContent = customer.name; //// add address
                        document.getElementById('headerAddress').textContent = customer.address; //// add address

                        li.textContent = ` Extra Earning: ${customer.totalIncome}â‚¹, Card Balance: ${customer.totalCardAmount}â‚¹`;
                        transactionList.appendChild(name);
                        transactionList.appendChild(li);

                        // Get today's date and subtract based on filter
                        const now = new Date();
                        let filterDate = null;

                        if (filter === "week") {
                            filterDate = new Date();
                            filterDate.setDate(now.getDate() - 7);
                        } else if (filter === "ten") {
                            filterDate = new Date();
                            filterDate.setDate(now.getDate() - 10);
                        } else if (filter === "month") {
                            filterDate = new Date();
                            filterDate.setMonth(now.getMonth() - 1);
                        } else if (filter === "six-months") {
                            filterDate = new Date();
                            filterDate.setMonth(now.getMonth() - 6);
                        } else if (filter === "year") {
                            filterDate = new Date();
                            filterDate.setFullYear(now.getFullYear() - 1);
                        } else if (filter === "twoyear") {
                            filterDate = new Date();
                            filterDate.setFullYear(now.getFullYear() - 2);
                        } else if (filter === "fiveyear") {
                            filterDate = new Date();
                            filterDate.setFullYear(now.getFullYear() - 5);
                        }

                        const transactions = customer.transactions || {};
                        for (const [dateTime, details] of Object.entries(transactions)) {
                            const transactionDate = new Date(dateTime);

                            // Show only transactions within the selected time range
                            if (!filterDate || transactionDate >= filterDate) {
                                const temp = details.cardAmount < 0 ? " à¤‰à¤§à¤¾à¤° à¤§à¤¨ à¤°à¤¾à¤¶à¤¿ ğŸ”»" : " à¤œà¤®à¤¾ à¤§à¤¨ à¤°à¤¾à¤¶à¤¿ ğŸ’¹";
                                let formatedDateTime = formatDateTime(dateTime);
                                let ownerPay = ownerPayMessage(details.ownerPay);

                                const transactionItem = document.createElement('li');
                                transactionItem.textContent = `${formatedDateTime}:  Total Cost :${details.buyAmount}â‚¹ğŸ’¸, Paid Amount :${details.paidAmount}â‚¹ğŸ’°, ${ownerPay}  ${temp}: ${details.cardAmount}â‚¹`;
                                transactionList.appendChild(transactionItem);
                            }
                        }
                    }
                });
            }
        };

        function ownerPayMessage(ownerPay) {
            return ownerPay !== 0 ? ` Payed by Owner is ${ownerPay}â‚¹ğŸ’², ` : ' ';
        }

        window.onload = async () => {
            await loadName();
            await loadPhoneNumber();
            const urlParams = new URLSearchParams(window.location.search);
            //const phone = window.location.pathname.split('/').pop();
            const phone = new URLSearchParams(window.location.search).get('phone');

            if (phone) {
                document.getElementById('customer-phone').value = phone;
                loadCustomerTransactions();
            }
        };

        function takeImage() {
            const name = document.querySelector("#salerName");
            const btns = document.querySelector("#printBtn");
            btns.style.display = 'none';
            name.style.display = 'flex';
            html2canvas(document.querySelector("#transactions")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'transactions.png'; // âœ… à¤«à¤¾à¤‡à¤² à¤•à¤¾ à¤¨à¤¾à¤®
                link.href = canvas.toDataURL("image/png"); // âœ… à¤‡à¤®à¥‡à¤œ URL
                link.click(); // âœ… à¤‡à¤®à¥‡à¤œ à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤•à¤°à¥‹
            });

            btns.style.display = 'flex';
            name.style.display = 'none';
        }

        function dataURLToBlob(dataURL) {
            let arr = dataURL.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        function shareImage() {
            const btns = document.querySelector("#printBtn");
            const name = document.querySelector("#salerName");
            btns.style.display = 'none';
            name.style.display = 'flex';

            html2canvas(document.querySelector("#transactions")).then(canvas => {
                let imgData = canvas.toDataURL("image/png");
                let blob = dataURLToBlob(imgData);
                let file = new File([blob], 'transaction.png', { type: 'image/png' });

                let shareData = {
                    files: [file],
                    title: "Transaction Details",
                    text: "Check out this transaction details!"
                };

                if (navigator.canShare && navigator.canShare(shareData)) {
                    navigator.share(shareData).catch(err => console.error("Error sharing image: ", err));
                } else {
                    alert("Sharing not supported, please download and share manually.");
                }
            });
            btns.style.display = 'flex';
            name.style.display = 'none';
        }
        window.shareImage = shareImage;
        window.takeImage = takeImage;
    </script>
</body>

</html>